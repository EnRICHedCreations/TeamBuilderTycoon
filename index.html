<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Builder Tycoon - Wholesaling Game</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --bg-dark: #171717;
            --card-dark: #202020;
            --text-light: #f0f0f0;
            --text-faded: #b0b0b0;
            --primary-gradient: linear-gradient(90deg, #7c6338, #ad9051);
            --border-color: #333;
            --success-color: #4CAF50;
            --error-color: #F44336;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg-dark); color: var(--text-light); min-height: 100vh; padding: 20px; }
        .game-container { max-width: 1400px; margin: 0 auto; background: var(--card-dark); border-radius: 10px; box-shadow: 0 8px 15px rgba(0,0,0,0.3); overflow: hidden; border: 1px solid var(--border-color); }
        .game-header { background: var(--card-dark); color: var(--text-light); padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; border-bottom: 2px solid var(--border-color); }
        .game-title { font-size: 28px; font-weight: 700; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stats-bar { display: flex; gap: 25px; flex-wrap: wrap; }
        .stat { display: flex; flex-direction: column; align-items: center; }
        .stat-label { font-size: 11px; text-transform: uppercase; opacity: 0.8; margin-bottom: 3px; color: var(--text-faded); }
        .stat-value { font-size: 18px; font-weight: bold; }
        .cash { background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .week { color: #90cdf4; }
        .deals { color: #ad9051; }
        .game-content { display: grid; grid-template-columns: 250px 1fr; min-height: 700px; }
        .sidebar { background: #252525; border-right: 1px solid var(--border-color); padding: 20px; }
        .nav-button { width: 100%; padding: 12px 15px; margin-bottom: 8px; background: var(--card-dark); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; text-align: left; color: var(--text-light); }
        .nav-button:hover { background: #2a2a2a; border-color: #ad9051; }
        .nav-button.active { background: var(--primary-gradient); color: var(--bg-dark); border-color: #ad9051; }
        .main-content { padding: 30px; overflow-y: auto; max-height: 700px; background: var(--bg-dark); }
        .section-title { font-size: 24px; font-weight: 700; margin-bottom: 20px; color: var(--text-light); border-bottom: 2px solid var(--border-color); padding-bottom: 10px; }
        .card { background: var(--card-dark); border: 1px solid var(--border-color); border-radius: 10px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .card-title { font-size: 18px; font-weight: 700; margin-bottom: 12px; color: var(--text-light); }
        .button { padding: 10px 20px; background: var(--primary-gradient); color: var(--bg-dark); border: none; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 14px; transition: all 0.3s; }
        .button:hover:not(:disabled) { opacity: 0.9; transform: translateY(-1px); }
        .button:disabled { background: #333; color: var(--text-faded); cursor: not-allowed; transform: none; }
        .button-small { padding: 6px 12px; font-size: 12px; }
        .button-success { background: var(--primary-gradient); }
        .button-success:hover:not(:disabled) { opacity: 0.9; }
        .button-danger { background: var(--error-color); color: white; }
        .button-danger:hover { opacity: 0.9; }
        .team-grid, .hire-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .team-member, .hire-card { border: 1px solid var(--border-color); border-radius: 10px; padding: 15px; background: #252525; }
        .hire-card { background: var(--card-dark); transition: all 0.2s; }
        .hire-card:hover { border-color: #ad9051; box-shadow: 0 4px 12px rgba(173, 144, 81, 0.2); }
        .team-member-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; }
        .team-member-name { font-weight: bold; font-size: 16px; color: var(--text-light); }
        .team-member-role { font-size: 12px; color: var(--text-faded); margin-bottom: 8px; }
        .progress-bar { background: #333; height: 8px; border-radius: 4px; overflow: hidden; margin: 8px 0; }
        .progress-fill { height: 100%; background: var(--primary-gradient); transition: width 0.3s; }
        .deal-pipeline { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
        .pipeline-column { background: #252525; border-radius: 10px; padding: 15px; min-height: 200px; border: 1px solid var(--border-color); }
        .pipeline-title { font-weight: bold; margin-bottom: 12px; color: var(--text-light); font-size: 14px; }
        .deal-card { background: var(--card-dark); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; margin-bottom: 8px; font-size: 13px; cursor: pointer; transition: all 0.2s; }
        .deal-card:hover { border-color: #ad9051; box-shadow: 0 2px 8px rgba(173, 144, 81, 0.3); }
        .deal-value { font-weight: bold; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-top: 5px; }
        .action-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
        .action-card { border: 1px solid var(--border-color); border-radius: 10px; padding: 20px; background: var(--card-dark); cursor: pointer; transition: all 0.2s; }
        .action-card:hover:not(.disabled) { border-color: #ad9051; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(173, 144, 81, 0.2); }
        .action-card.disabled { opacity: 0.5; cursor: not-allowed; }
        .action-title { font-weight: bold; font-size: 16px; margin-bottom: 8px; color: var(--text-light); }
        .action-cost { color: var(--text-faded); font-size: 13px; margin-bottom: 8px; }
        .time-badge { display: inline-block; background: #333; color: #ad9051; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; border: 1px solid #ad9051; }
        .cost-badge { display: inline-block; background: var(--primary-gradient); color: var(--bg-dark); padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; margin-left: 5px; }
        .locked-badge { display: inline-block; background: var(--error-color); color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; margin-top: 5px; }
        .notification { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card-dark); border-left: 6px solid #ad9051; padding: 25px 35px; border-radius: 10px; box-shadow: 0 8px 24px rgba(0,0,0,0.5); max-width: 500px; font-size: 18px; font-weight: 600; animation: popIn 0.3s; z-index: 1000; text-align: center; color: black; border: 1px solid var(--border-color); }
        @keyframes popIn { from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--card-dark); border-radius: 10px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; border: 1px solid var(--border-color); }
        .modal-title { font-size: 24px; font-weight: bold; margin-bottom: 15px; color: var(--text-light); }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color); }
        .info-label { color: var(--text-faded); font-size: 14px; }
        .info-value { font-weight: 600; font-size: 14px; color: var(--text-light); }
        .property-list { max-height: 300px; overflow-y: auto; margin: 15px 0; }
        .property-option { border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; background: #252525; }
        .property-option:hover { border-color: #ad9051; background: #2a2a2a; }
        .property-option.selected { border-color: #ad9051; background: #333; }
        @media (max-width: 768px) { .game-content { grid-template-columns: 1fr; } .sidebar { border-right: none; border-bottom: 1px solid var(--border-color); } }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <div class="game-title"><i class="fa-solid fa-building"></i> Team Builder Tycoon - Build Your Wholesaling Empire</div>
            <div class="stats-bar">
                <div class="stat"><div class="stat-label">Cash</div><div class="stat-value cash">$<span id="cash">0</span></div></div>
                <div class="stat"><div class="stat-label">Week</div><div class="stat-value week"><span id="week">1</span></div></div>
                <div class="stat"><div class="stat-label">Deals Closed</div><div class="stat-value deals"><span id="dealsCount">0</span></div></div>
                <div class="stat"><div class="stat-label">Time Left</div><div class="stat-value"><span id="timeLeft">40</span>h</div></div>
            </div>
        </div>
        <div class="game-content">
            <div class="sidebar">
                <button class="nav-button active" data-section="actions"><i class="fa-solid fa-list-check"></i> Actions</button>
                <button class="nav-button" data-section="deals"><i class="fa-solid fa-briefcase"></i> Deals</button>
                <button class="nav-button" data-section="team"><i class="fa-solid fa-users"></i> Team</button>
                <button class="nav-button" data-section="hire"><i class="fa-solid fa-plus"></i> Hire</button>
                <button class="nav-button" data-section="upgrades"><i class="fa-solid fa-arrow-up"></i> Upgrades</button>
                <button class="nav-button" data-section="stats"><i class="fa-solid fa-chart-bar"></i> Stats</button>
                <button class="nav-button" data-section="settings"><i class="fa-solid fa-gear"></i> Settings</button>
            </div>
            <div class="main-content">
                <div id="content-actions" class="content-section">
                    <div class="section-title" id="actionsSectionTitle">Weekly Actions</div>
                    <div class="action-grid" id="actionGrid"></div>
                    <div style="margin-top: 30px;">
                        <button class="button button-success" id="advanceWeekBtn" style="font-size: 16px; padding: 15px 30px;"><i class="fa-solid fa-forward"></i> Advance to Next Week</button>
                    </div>
                </div>
                <div id="content-deals" class="content-section" style="display:none;">
                    <div class="section-title">Deal Pipeline</div>
                    <div class="deal-pipeline" id="dealPipeline"></div>
                </div>
                <div id="content-team" class="content-section" style="display:none;">
                    <div class="section-title">My Team</div>
                    <div class="team-grid" id="teamGrid"></div>
                    <div id="soloMessage" style="text-align: center; padding: 40px; color: #718096;">
                        <div style="font-size: 48px; margin-bottom: 15px;"><i class="fa-solid fa-user-shield"></i></div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Flying Solo!</div>
                        <div>You haven't hired anyone yet. Check the Hire tab when you're ready to build your team.</div>
                    </div>
                </div>
                <div id="content-hire" class="content-section" style="display:none;">
                    <div class="section-title">Hire Team Members</div>
                    <div class="hire-grid" id="hireGrid"></div>
                </div>
                <div id="content-upgrades" class="content-section" style="display:none;">
                    <div class="section-title">Upgrades & Tools</div>
                    <div class="hire-grid" id="upgradeGrid"></div>
                </div>
                <div id="content-stats" class="content-section" style="display:none;">
                    <div class="section-title">Your Stats & Achievements</div>
                    <div id="statsContent"></div>
                </div>
                <div id="content-settings" class="content-section" style="display:none;">
                    <div class="section-title">Game Settings</div>
                    <div class="card">
                        <div class="card-title"><i class="fa-solid fa-graduation-cap"></i> Tutorial</div>
                        <p style="margin-bottom: 15px; color: #718096;">Need a refresher on how to play?</p>
                        <button class="button button-success" id="showTutorialBtn">Show How to Play</button>
                    </div>
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-title"><i class="fa-solid fa-rotate-right"></i> Reset Progress</div>
                        <p style="margin-bottom: 15px; color: #718096;">Start a new game from scratch. This will delete all progress.</p>
                        <button class="button button-danger" id="resetBtn">Reset Game</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle"></div>
            <div id="modalBody"></div>
            <div class="modal-buttons">
                <button class="button" id="closeModalBtn">Close</button>
            </div>
        </div>
    </div>
    <div id="propertyModal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="propertyModalTitle">Select a Property</div>
            <div id="propertyModalBody"></div>
            <div class="modal-buttons">
                <button class="button" id="confirmPropertyBtn">Confirm</button>
                <button class="button" id="cancelPropertyBtn">Cancel</button>
            </div>
        </div>
    </div>
    <div id="sellerModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-title" id="sellerModalTitle"><i class="fa-solid fa-phone"></i> Calling Seller...</div>
            <div id="sellerModalBody" style="max-height: 400px; overflow-y: auto;">
                <div id="sellerPersona" style="background: #252525; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 13px; color: var(--text-faded);"></div>
                <div id="sellerDialogue" style="margin-bottom: 20px;"></div>
                <div id="sellerMCTP" style="background: #252525; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 13px;">
                    <div style="font-weight: 600; margin-bottom: 8px; color: var(--text-light);">Info Gathered:</div>
                    <div id="mctpStatus"></div>
                </div>
                <div id="sellerChoices"></div>
            </div>
            <div class="modal-buttons">
                <button class="button button-danger" id="endCallBtn">End Call</button>
            </div>
        </div>
    </div>
    <div id="tutorialModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-title"><i class="fa-solid fa-graduation-cap"></i> How to Play Team Builder Tycoon</div>
            <div style="max-height: 60vh; overflow-y: auto; padding-right: 10px;">
                <div style="margin-bottom: 20px;">
                    <h3 style="color: #ad9051; margin-bottom: 10px; font-size: 16px;"><i class="fa-solid fa-flag-checkered"></i> Your Goal</h3>
                    <p style="color: var(--text-faded); line-height: 1.6;">Build a successful real estate wholesaling empire from just $500. Close deals, hire team members, buy upgrades, and scale your operation from solo hustle to automated income machine.</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="color: #ad9051; margin-bottom: 10px; font-size: 16px;"><i class="fa-solid fa-route"></i> The Deal Pipeline</h3>
                    <p style="color: var(--text-faded); line-height: 1.6; margin-bottom: 8px;">Every deal goes through stages:</p>
                    <ol style="color: var(--text-faded); line-height: 1.8; margin-left: 20px;">
                        <li><strong>Lead</strong> → Pull lists & contact them</li>
                        <li><strong>Qualified</strong> → Interested seller, now analyze property</li>
                        <li><strong>Analyzed</strong> → Numbers work, meet with seller</li>
                        <li><strong>Follow-up/Negotiation</strong> → Work the deal</li>
                        <li><strong>Contract</strong> → Signed! Contact buyers to close</li>
                    </ol>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="color: #ad9051; margin-bottom: 10px; font-size: 16px;"><i class="fa-solid fa-clock"></i> Time Management</h3>
                    <p style="color: var(--text-faded); line-height: 1.6;">You start with 40 hours per week. Every action costs time. When you run out of time or click "Advance Week", the week ends and your time resets. Team members add hours to your weekly capacity.</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="color: #ad9051; margin-bottom: 10px; font-size: 16px;"><i class="fa-solid fa-chart-line"></i> Early Game Strategy</h3>
                    <ul style="color: var(--text-faded); line-height: 1.8; margin-left: 20px;">
                        <li>Pull free government lists repeatedly (25% chance of 1 lead)</li>
                        <li>Cold call leads to qualify them (10-15% success rate)</li>
                        <li>Consider Premium Gov List ($75) for 1-3 guaranteed leads</li>
                        <li>Move qualified leads through the pipeline</li>
                        <li>Expect 20-30 hours of work for your first deal</li>
                        <li>Deals can fall through at any stage - maintain a healthy funnel!</li>
                    </ul>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="color: #ad9051; margin-bottom: 10px; font-size: 16px;"><i class="fa-solid fa-rocket"></i> Growth Path</h3>
                    <p style="color: var(--text-faded); line-height: 1.6;">After 3-5 deals, start buying upgrades like Skip Trace and Batch Dialer. Each upgrade provides 2-100x improvements. Hire team members to add weekly hours and passive benefits. Balance monthly costs carefully - bankruptcy ends the game!</p>
                </div>

                <div style="background: #252525; padding: 15px; border-radius: 8px; border-left: 4px solid #ad9051;">
                    <p style="color: var(--text-light); font-weight: 600; margin-bottom: 8px;"><i class="fa-solid fa-lightbulb"></i> Pro Tips</p>
                    <ul style="color: var(--text-faded); line-height: 1.8; margin-left: 20px; font-size: 14px;">
                        <li>Check pipeline counters in the Actions tab title</li>
                        <li>VAs generate leads offline (1h minimum, 8h max)</li>
                        <li>Premium Gov List ($75) gives guaranteed 1-3 leads</li>
                        <li>Pay Per Lead ($200) skips straight to Analyzed stage</li>
                        <li>Watch your cash - team costs are due every 4 weeks</li>
                    </ul>
                </div>
            </div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="button button-success" id="closeTutorialBtn" style="width: 100%;">Let's Build an Empire!</button>
            </div>
        </div>
    </div>
    <script>
        const g = { cash: 500, week: 1, timeLeft: 40, dealsClosedTotal: 0, totalProfit: 0, team: [], deals: [], closedDeals: [], upgrades: {}, adminBlocked: false, offlineTime: 0, lastPlayTime: Date.now(), prestigeLevel: 0, dailyLoginStreak: 0, lastLoginDate: null };
        let sel = null, pend = null;
        let notifQueue = [], notifActive = false;
        let autoAdvancing = false;
        let currentSeller = null;

        const mkOpts = [
            { id: 'gov', name: 'Pull Government List', cost: 0, leads: 0.25, desc: 'Free public records (low yield)', time: 0.5 },
            { id: 'govPremium', name: 'Premium Government List', cost: 75, leads: [1, 3], desc: 'Better data sources ($75)', time: 0.5 },
            { id: 'ppl', name: 'Pay Per Lead', cost: 200, leads: 1, desc: 'Pre-qualified lead ready to analyze ($200)', req: 200 },
            { id: 'ppc', name: 'Pay Per Click', cost: 2000, leads: [20, 35], desc: 'Weekly PPC ($2000)', req: 2000, time: 2 }
        ];

        const contact = [
            { id: 'call', name: 'Cold Call Single Lead', time: 0.5, cost: 0, desc: 'Call 1 lead', cnt: 1, rate: [0.10, 0.15] },
            { id: 'text', name: 'Text Single Lead', time: 0.1, cost: 2, desc: 'Text 1 lead ($2)', cnt: 1, rate: [0.05, 0.08] },
            { id: 'batchCall', name: 'Batch Call (5 leads)', time: 2, cost: 0, desc: 'Call 5 leads at once', cnt: 5, rate: [0.15, 0.20], reqUpg: 'batchDialer' },
            { id: 'textBlast', name: 'Text Blast Campaign', time: 1, cost: 200, desc: '1000 texts ($200)', cnt: 1000, rate: [0.03, 0.08], reqUpg: 'textDrip' }
        ];

        const upg = {
            skipTrace: { name: 'Skip Trace Tool', cost: 1000, ben: 'Government lists give 2-5 leads instead of base amount', type: 'marketing', reqD: 3 },
            batchDialer: { name: 'Batch Dialer', cost: 2500, ben: 'Unlock batch calling (5 leads at once)', type: 'call', reqD: 5 },
            xleads: { name: 'XLeads Software', cost: 5000, ben: 'Government lists give 10-20 leads', type: 'marketing', reqD: 12 },
            textDrip: { name: 'Text Drip Campaign', cost: 3000, ben: 'Unlock text blast (1000 texts, 3-8% success)', type: 'text', reqD: 15 },
            enzo: { name: 'Enzo Power Dialer', cost: 8000, ben: '+30h/week + unlock power dialing', type: 'call', monthly: 225, reqD: 20 },
            maxd: { name: 'MaxDispo.com Partnership', cost: 0, ben: '+50% deal value on all closes', type: 'dispo', reqD: 75 }
        };

        const teams = {
            va: { name: 'Virtual Assistant', role: 'VA', cost: 800, time: 20, desc: '+20h/week, generates 12 leads weekly (starts 50% efficient)', eff: 50, mor: 100, leads: 12, reqC: 2400, reqD: 2 },
            acq: { name: 'Acquisitions Manager', role: 'Acq', cost: 2500, time: 15, desc: '+15h/week for deal processing capacity', eff: 50, mor: 100, deals: 3, reqC: 7500, reqD: 4 },
            dis: { name: 'Dispositions', role: 'Dis', cost: 2000, time: 10, desc: '+10h/week, adds $2,000 bonus to every closed deal', eff: 50, mor: 100, bonus: 2000, reqC: 6000, reqD: 5 }
        };

        const acts = [
            { id: 'analyze', name: 'Analyze Property', time: 1.5, cost: 0, desc: 'Run comps', prop: true, stage: 'qualified' },
            { id: 'show', name: 'Call/Meet with Seller', time: 2, cost: 0, desc: 'Meet seller', prop: true, stage: 'analyzed', interactive: true },
            { id: 'follow', name: 'Follow Up', time: 1, cost: 0, desc: 'Build rapport', prop: true, stage: 'followup' },
            { id: 'negotiate', name: 'Negotiate', time: 3, cost: 0, desc: 'Work terms', prop: true, stage: 'negotiation', interactive: true },
            { id: 'revise', name: 'Revise Offer', time: 1, cost: 0, desc: 'New offer', prop: true, stage: 'revision', interactive: true },
            { id: 'buyers', name: 'Contact Buyers', time: 4, cost: 0, desc: 'Reach buyers', prop: true, stage: 'contract' },
            { id: 'maxdispo', name: 'Dispo with MaxDispo.com', time: 0.5, cost: 0, desc: 'Quick close (50% fee)', prop: true, stage: 'contract', minVal: 8000, reqUpg: 'maxd' },
            { id: 'admin', name: 'Admin Tasks', time: 2, cost: 0, desc: 'Paperwork', prop: false }
        ];

        const sellerPersonas = [
            { id: 'skeptical', name: 'Skeptical Seller', desc: 'Cautious and wants proof of credibility', trust: 3 },
            { id: 'emotional', name: 'Emotional Seller', desc: 'Attached to the property, needs empathy', trust: 5 },
            { id: 'rushed', name: 'Rushed Seller', desc: 'In a hurry, values efficiency', trust: 4 },
            { id: 'motivated', name: 'Motivated Seller', desc: 'Eager to sell, flexible on terms', trust: 7 },
            { id: 'analytical', name: 'Analytical Seller', desc: 'Data-driven, wants facts and figures', trust: 4 }
        ];

        const dialogueScenarios = {
            show: {
                opening: [
                    { text: "Hi, I appreciate you taking my call. I understand you're looking to sell your property?", impact: { trust: 1 } },
                    { text: "Hello! I'm a real estate investor and I want to buy your house. What's your bottom line?", impact: { trust: -2 } },
                    { text: "Hey, I saw your property listing. Tell me what's wrong with it and why you need to sell fast.", impact: { trust: -1 } },
                    { text: "Good morning! Thank you for your time. I work with homeowners in situations like yours.", impact: { trust: 2 } },
                    { text: "Yo, what's up? I buy houses. You trying to sell or what?", impact: { trust: -3 } },
                    { text: "Hello, my name is on the card I left. Did you get a chance to look at it?", impact: { trust: 0 } }
                ],
                motivation: [
                    { text: "What's prompting you to sell at this time?", impact: { trust: 1, reveals: 'M' } },
                    { text: "Are you just testing the market or do you actually need to sell?", impact: { trust: -1 } },
                    { text: "I understand transitions can be challenging. What's your situation?", impact: { trust: 2, reveals: 'M' } },
                    { text: "Help me understand what brought you to this decision.", impact: { trust: 1, reveals: 'M' } },
                    { text: "Why are you wasting my time if you're not serious about selling?", impact: { trust: -3 } },
                    { text: "Every property has a story. What's yours?", impact: { trust: 2, reveals: 'M' } }
                ],
                condition: [
                    { text: "Can you tell me about the condition of the property? Any major repairs needed?", impact: { trust: 1, reveals: 'C' } },
                    { text: "I'll need to inspect it myself, but what issues should I know about?", impact: { trust: 0, reveals: 'C' } },
                    { text: "How much money have you had to sink into repairs lately?", impact: { trust: -1 } },
                    { text: "Walk me through the property - what's working well and what might need attention?", impact: { trust: 1, reveals: 'C' } },
                    { text: "Look, I've seen it all. Just tell me what's broken so I can lowball you properly.", impact: { trust: -3 } },
                    { text: "When was the last time any major systems were updated?", impact: { trust: 0, reveals: 'C' } }
                ],
                timeline: [
                    { text: "What's your ideal timeline for closing?", impact: { trust: 1, reveals: 'T' } },
                    { text: "How quickly do you need this done?", impact: { trust: 0, reveals: 'T' } },
                    { text: "I can close fast if the price is right. When do you need out?", impact: { trust: -1, reveals: 'T' } },
                    { text: "Help me understand your timeframe so I can structure the best offer.", impact: { trust: 2, reveals: 'T' } },
                    { text: "I close in 7 days cash. That should work for you, right?", impact: { trust: -1 } },
                    { text: "Is there any flexibility in when you'd like to close?", impact: { trust: 1, reveals: 'T' } }
                ],
                price: [
                    { text: "What price range were you hoping for?", impact: { trust: 0, reveals: 'P' } },
                    { text: "Based on condition and comps, I'm thinking around a certain amount. Does that work for you?", impact: { trust: 1, reveals: 'P' } },
                    { text: "I need to make a profit here. What's your absolute lowest number?", impact: { trust: -2 } },
                    { text: "Have you had the property appraised or do you have a number in mind?", impact: { trust: 1, reveals: 'P' } },
                    { text: "Listen, I'll be straight - what's your rock bottom number so we don't waste time?", impact: { trust: -3 } },
                    { text: "I want to make you a fair offer. What would you consider fair?", impact: { trust: 2, reveals: 'P' } }
                ]
            },
            negotiate: {
                pushback: [
                    { text: "I understand your concerns. Let me see if we can find a middle ground that works for both of us.", impact: { trust: 2 } },
                    { text: "That's my offer. Take it or leave it.", impact: { trust: -3 } },
                    { text: "I hear you. What if we adjust the closing timeline to give you more flexibility?", impact: { trust: 1 } },
                    { text: "Let's take a step back and look at what's important to you in this deal.", impact: { trust: 2 } },
                    { text: "You're pushing back on everything. Do you even want to sell?", impact: { trust: -3 } },
                    { text: "I appreciate your perspective. What if we structured it differently?", impact: { trust: 1 } }
                ],
                objection: [
                    { text: "I completely understand. What would make this work better for you?", impact: { trust: 2 } },
                    { text: "Look, this is a fair offer based on the market. You won't get better.", impact: { trust: -2 } },
                    { text: "Let me explain how I arrived at this number...", impact: { trust: 1 } },
                    { text: "You're right to have concerns. Let's address each one.", impact: { trust: 2 } },
                    { text: "Every seller says that. The market doesn't care about your feelings.", impact: { trust: -3 } },
                    { text: "What specific part of the offer concerns you most?", impact: { trust: 1 } }
                ]
            },
            revise: {
                adjustment: [
                    { text: "I've thought about your feedback. Here's an improved offer that addresses your concerns.", impact: { trust: 2 } },
                    { text: "Fine, I'll go a bit higher, but this is my final offer.", impact: { trust: 0 } },
                    { text: "After running the numbers again, I can increase my offer slightly.", impact: { trust: 1 } },
                    { text: "I spoke with my partner and we can make some adjustments to work with you.", impact: { trust: 2 } },
                    { text: "Take it or leave it. I've already given you more than I should have.", impact: { trust: -2 } },
                    { text: "Based on our conversation, here's a revised offer that's fair for both of us.", impact: { trust: 1 } }
                ]
            }
        };

        function calcOfflineProgress() {
            if (!g.lastPlayTime) {
                g.lastPlayTime = Date.now();
                save(); // Save immediately to prevent exploit
                return null;
            }

            const now = Date.now();
            const timeAway = now - g.lastPlayTime;
            const hoursAway = timeAway / (1000 * 60 * 60);

            // Cap offline progress at 8 hours
            const effectiveHours = Math.min(hoursAway, 8);

            // Require at least 1 hour away to prevent refresh exploit
            if (effectiveHours < 1.0) return null;

            let leadsGenerated = 0;
            let dealsProcessed = 0;
            let cashEarned = 0;

            // Calculate leads from VAs (5-10 leads every 8 hours per VA)
            const vaCount = g.team.filter(m => m.role === 'VA').length;
            if (vaCount > 0) {
                const cycles = Math.floor(effectiveHours / 8);
                const partialCycle = (effectiveHours % 8) / 8;

                for (let i = 0; i < vaCount; i++) {
                    const va = g.team.filter(m => m.role === 'VA')[i];
                    const efficiency = (va.eff || 50) / 100;

                    // Full cycles
                    for (let c = 0; c < cycles; c++) {
                        const leads = Math.floor((Math.random() * 6 + 5) * efficiency); // 5-10 leads * efficiency
                        leadsGenerated += leads;
                    }

                    // Partial cycle
                    if (partialCycle > 0) {
                        const leads = Math.floor((Math.random() * 6 + 5) * efficiency * partialCycle);
                        leadsGenerated += leads;
                    }
                }
            }

            g.lastPlayTime = now;

            return {
                hoursAway: Math.floor(effectiveHours * 10) / 10,
                leadsGenerated,
                dealsProcessed,
                cashEarned
            };
        }

        function showOfflinePopup(progress) {
            if (!progress || progress.leadsGenerated === 0) return;

            const modal = document.getElementById('modal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');

            title.innerHTML = '<i class="fa-solid fa-clock"></i> While You Were Away...';
            body.innerHTML = `
                <div style="text-align:center; padding:20px 0;">
                    <div style="font-size:48px; margin-bottom:20px;"><i class="fa-solid fa-briefcase"></i></div>
                    <div style="font-size:18px; margin-bottom:25px; color:#718096;">
                        You were away for ${progress.hoursAway} hours
                    </div>
                    ${progress.leadsGenerated > 0 ? `
                        <div class="info-row">
                            <span class="info-label">Leads Generated:</span>
                            <span class="info-value" style="color:#48bb78;">+${progress.leadsGenerated}</span>
                        </div>
                    ` : ''}
                    ${progress.dealsProcessed > 0 ? `
                        <div class="info-row">
                            <span class="info-label">Deals Processed:</span>
                            <span class="info-value" style="color:#48bb78;">+${progress.dealsProcessed}</span>
                        </div>
                    ` : ''}
                    ${progress.cashEarned > 0 ? `
                        <div class="info-row">
                            <span class="info-label">Cash Earned:</span>
                            <span class="info-value" style="color:#48bb78;">+$${progress.cashEarned.toLocaleString()}</span>
                        </div>
                    ` : ''}
                </div>
            `;

            modal.classList.add('active');
        }

        function init() {
            load();

            // Calculate and show offline progress
            const offlineProgress = calcOfflineProgress();
            if (offlineProgress && offlineProgress.leadsGenerated > 0) {
                genLeads(offlineProgress.leadsGenerated);
                showOfflinePopup(offlineProgress);
            }

            // Show tutorial on first play
            const hasSeenTutorial = localStorage.getItem('teamBuildingTycoon_tutorial');
            if (!hasSeenTutorial) {
                setTimeout(() => {
                    document.getElementById('tutorialModal').classList.add('active');
                }, 500);
            }

            document.querySelectorAll('.nav-button').forEach(b => b.addEventListener('click', function() { showSec(this.dataset.section); }));
            document.getElementById('advanceWeekBtn').addEventListener('click', advWeek);
            document.getElementById('resetBtn').addEventListener('click', reset);
            document.getElementById('closeModalBtn').addEventListener('click', closeMod);
            document.getElementById('confirmPropertyBtn').addEventListener('click', confirmProp);
            document.getElementById('cancelPropertyBtn').addEventListener('click', closePropMod);
            document.getElementById('closeTutorialBtn').addEventListener('click', closeTutorial);
            document.getElementById('showTutorialBtn').addEventListener('click', showTutorial);
            document.getElementById('endCallBtn').addEventListener('click', () => endSellerCall(false));
            renderActs();
            renderTeam();
            renderHire();
            renderUpg();
            renderDeals();
            renderStats();
            updateUI();
        }

        function closeTutorial() {
            document.getElementById('tutorialModal').classList.remove('active');
            localStorage.setItem('teamBuildingTycoon_tutorial', 'true');
        }

        function showTutorial() {
            document.getElementById('tutorialModal').classList.add('active');
        }

        function showSec(s) {
            document.querySelectorAll('.content-section').forEach(e => e.style.display = 'none');
            document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
            document.getElementById('content-' + s).style.display = 'block';
            document.querySelector('[data-section="' + s + '"]').classList.add('active');
            if (s === 'stats') renderStats();
        }

        function renderActs() {
            const grid = document.getElementById('actionGrid');

            // Calculate pipeline counts
            const pipelineCounts = {
                lead: g.deals.filter(d => d.stage === 'lead').length,
                qualified: g.deals.filter(d => d.stage === 'qualified').length,
                analyzed: g.deals.filter(d => d.stage === 'analyzed').length,
                followup: g.deals.filter(d => d.stage === 'followup').length,
                revision: g.deals.filter(d => d.stage === 'revision').length,
                negotiation: g.deals.filter(d => d.stage === 'negotiation').length,
                contract: g.deals.filter(d => d.stage === 'contract').length
            };

            // Update section title with pipeline counts
            const titleEl = document.getElementById('actionsSectionTitle');
            titleEl.innerHTML = `Weekly Actions <span style="font-size: 14px; color: #718096; font-weight: normal; margin-left: 15px;">
                <i class="fa-solid fa-inbox"></i> Leads: ${pipelineCounts.lead} |
                <i class="fa-solid fa-check-circle"></i> Qualified: ${pipelineCounts.qualified} |
                <i class="fa-solid fa-chart-bar"></i> Analyzed: ${pipelineCounts.analyzed} |
                <i class="fa-solid fa-phone"></i> Follow-up: ${pipelineCounts.followup} |
                <i class="fa-solid fa-file-signature"></i> Negotiation: ${pipelineCounts.negotiation + pipelineCounts.revision} |
                <i class="fa-solid fa-file-contract"></i> Contract: ${pipelineCounts.contract}
            </span>`;

            let h = '';

            mkOpts.forEach(o => {
                const hasTime = !o.time || g.timeLeft >= o.time;
                const ok = g.cash >= o.cost && hasTime;
                const lock = o.req && g.dealsClosedTotal === 0 && g.cash < o.req;
                const leadsTxt = Array.isArray(o.leads) ? `${o.leads[0]}-${o.leads[1]}` : o.leads;
                h += `<div class="action-card ${!ok || lock ? 'disabled' : ''}" onclick="${ok && !lock ? `doMkt('${o.id}')` : ''}">
                    <div class="action-title">${o.name}</div><div class="action-cost">${o.desc}</div>
                    <div style="margin-top:10px;">${o.time ? '<span class="time-badge"><i class="fa-solid fa-clock"></i> ' + o.time + 'h</span>' : ''}<span class="cost-badge"><i class="fa-solid fa-dollar-sign"></i> ${o.cost === 0 ? 'FREE' : '$' + o.cost}</span>
                    <span class="time-badge"><i class="fa-solid fa-inbox"></i> ${leadsTxt}</span>${lock ? '<div class="locked-badge">Need $' + o.req + '</div>' : ''}</div></div>`;
            });

            contact.forEach(o => {
                const hasUpg = !o.reqUpg || g.upgrades[o.reqUpg];
                const ok = g.cash >= o.cost && g.timeLeft >= o.time && hasUpg;
                const lock = (o.req && g.cash < o.req) || (o.reqUpg && !g.upgrades[o.reqUpg]);
                const lockMsg = o.reqUpg && !g.upgrades[o.reqUpg] ? `Need ${upg[o.reqUpg].name}` : (o.req && g.cash < o.req ? '$' + o.cost : '');
                h += `<div class="action-card ${!ok || lock ? 'disabled' : ''}" onclick="${ok && !lock ? `doContact('${o.id}')` : ''}">
                    <div class="action-title">${o.name}</div><div class="action-cost">${o.desc}</div>
                    <div style="margin-top:10px;"><span class="time-badge"><i class="fa-solid fa-clock"></i> ${o.time}h</span>
                    <span class="cost-badge"><i class="fa-solid fa-dollar-sign"></i> ${o.cost === 0 ? 'FREE' : '$' + o.cost}</span>${lock && lockMsg ? '<div class="locked-badge">' + lockMsg + '</div>' : ''}</div></div>`;
            });

            acts.forEach(a => {
                const blocked = g.adminBlocked && a.prop;
                const isAdmin = a.id === 'admin';
                const adminRequired = g.adminBlocked && isAdmin;
                const hasUpg = !a.reqUpg || g.upgrades[a.reqUpg];
                const upgLocked = a.reqUpg && !g.upgrades[a.reqUpg];
                const ok = g.cash >= a.cost && g.timeLeft >= a.time && !blocked && hasUpg;
                const highlight = adminRequired ? ' style="border: 3px solid #f56565; box-shadow: 0 0 20px rgba(245,101,101,0.5);"' : '';
                const lockMsg = upgLocked ? `Need ${upg[a.reqUpg].name}` : '';
                h += `<div class="action-card ${!ok || blocked || upgLocked ? 'disabled' : ''}" onclick="${ok && !blocked && !upgLocked ? `doAct('${a.id}')` : ''}"${highlight}>
                    <div class="action-title">${a.name}${blocked ? ' <i class="fa-solid fa-lock"></i>' : ''}${upgLocked ? ' <i class="fa-solid fa-lock"></i>' : ''}${adminRequired ? ' <i class="fa-solid fa-exclamation-triangle"></i> URGENT' : ''}</div><div class="action-cost">${a.desc}</div>
                    <div style="margin-top:10px;"><span class="time-badge"><i class="fa-solid fa-clock"></i> ${a.time}h</span>${a.cost > 0 ? '<span class="cost-badge"><i class="fa-solid fa-dollar-sign"></i> $' + a.cost + '</span>' : ''}${blocked ? '<div class="locked-badge">Admin work needed!</div>' : ''}${upgLocked && lockMsg ? '<div class="locked-badge">' + lockMsg + '</div>' : ''}</div></div>`;
            });

            grid.innerHTML = h;
        }

        function doMkt(id) {
            const o = mkOpts.find(x => x.id === id);
            if (g.cash < o.cost || (o.time && g.timeLeft < o.time)) return;
            g.cash -= o.cost;
            if (o.time) g.timeLeft -= o.time;

            let leadCnt;

            // Handle probabilistic lead generation (e.g., 0.15 = 15% chance of 1 lead)
            if (typeof o.leads === 'number' && o.leads < 1) {
                leadCnt = Math.random() < o.leads ? 1 : 0;
            } else if (Array.isArray(o.leads)) {
                leadCnt = Math.floor(Math.random() * (o.leads[1] - o.leads[0] + 1)) + o.leads[0];
            } else {
                leadCnt = o.leads;
            }

            // Apply upgrade modifiers
            if ((id === 'gov' || id === 'govPremium') && g.upgrades.xleads) {
                leadCnt = Math.floor(Math.random() * 11) + 10; // 10-20 leads
            } else if ((id === 'gov' || id === 'govPremium') && g.upgrades.skipTrace) {
                leadCnt = Math.floor(Math.random() * 4) + 2; // 2-5 leads
            }

            if (leadCnt === 0) {
                notify(`${o.name}: No leads.`);
            } else {
                // Pay Per Lead generates pre-qualified leads (analyzed stage)
                const stage = id === 'ppl' ? 'analyzed' : 'lead';
                genLeads(leadCnt, stage);
                if (id === 'ppl') {
                    notify(`${o.name}: ${leadCnt} pre-qualified lead${leadCnt > 1 ? 's' : ''} ready to analyze!`, 'advance');
                } else {
                    notify(`${o.name}: ${leadCnt} lead${leadCnt > 1 ? 's' : ''}!`, 'advance');
                }
            }

            updateUI();
            renderActs();
            renderDeals();
            save();
        }

        function doContact(id) {
            const o = contact.find(x => x.id === id);
            if (g.timeLeft < o.time || g.cash < o.cost) return;

            const leadPool = g.deals.filter(d => d.stage === 'lead');
            const toContact = Math.min(o.cnt, leadPool.length);

            if (toContact === 0) {
                notify(`${o.name}: No leads to contact!`);
                return;
            }

            g.timeLeft -= o.time;
            g.cash -= o.cost;

            // Take leads from pool
            const contacted = leadPool.slice(0, toContact);
            g.deals = g.deals.filter(d => !contacted.includes(d));

            let r = Array.isArray(o.rate) ? Math.random() * (o.rate[1] - o.rate[0]) + o.rate[0] : o.rate;

            // Apply upgrade bonuses
            if (id === 'textBlast' && g.upgrades.textDrip) r *= 1.5;

            let q = 0;

            // Check each contact individually with probability
            for (let i = 0; i < toContact; i++) {
                if (Math.random() < r) q++;
            }

            if (q > 0) {
                // Convert contacted leads to qualified
                contacted.slice(0, q).forEach(d => {
                    d.stage = 'qualified';
                    g.deals.push(d);
                });
                notify(`${o.name}: ${q} of ${toContact} qualified!`, 'advance');
            } else {
                notify(`${o.name}: Contacted ${toContact}, none qualified.`);
            }

            updateUI();
            renderActs();
            renderDeals();
            save();
        }

        function doAct(id) {
            const a = acts.find(x => x.id === id);
            if (!a || g.timeLeft < a.time || g.cash < a.cost) {
                notify('Not enough time/cash!');
                return;
            }
            if (a.reqUpg && !g.upgrades[a.reqUpg]) {
                notify(`Need ${upg[a.reqUpg].name} upgrade!`);
                return;
            }
            if (a.prop) {
                showPropModal(a);
            } else {
                execAct(a, null);
            }
        }

        function startSellerInteraction(action, property) {
            const persona = sellerPersonas[Math.floor(Math.random() * sellerPersonas.length)];
            currentSeller = {
                action: action.id,
                property: property,
                persona: persona,
                trust: persona.trust,
                mctp: { M: false, C: false, T: false, P: false },
                turn: 0,
                dialogue: [],
                askedCategories: [] // Track which categories have been asked
            };

            // Clear previous dialogue history
            document.getElementById('sellerDialogue').innerHTML = '';
            document.getElementById('sellerPersona').textContent = `${persona.name} - ${persona.desc}`;

            // Update modal title based on action
            const titles = {
                'show': '<i class="fa-solid fa-phone"></i> Calling Seller...',
                'negotiate': '<i class="fa-solid fa-handshake"></i> Negotiating Terms...',
                'revise': '<i class="fa-solid fa-file-pen"></i> Revising Offer...'
            };
            document.getElementById('sellerModalTitle').innerHTML = titles[action.id] || '<i class="fa-solid fa-phone"></i> Calling Seller...';

            // Show/hide MCTP display based on action
            const mctpDiv = document.getElementById('sellerMCTP');
            if (action.id === 'show') {
                mctpDiv.style.display = 'block';
                updateMCTPDisplay();
            } else {
                // For negotiate and revise, only show trust
                mctpDiv.style.display = 'block';
                document.getElementById('mctpStatus').innerHTML = `
                    <div style="text-align: center; font-size: 14px; font-weight: 600; color: var(--text-light);">
                        Trust Level: <span style="color: ${currentSeller.trust >= 3 ? '#48bb78' : '#f56565'};">${currentSeller.trust}</span>
                    </div>
                `;
            }

            showNextDialogueChoice();
            document.getElementById('sellerModal').classList.add('active');
        }

        function updateMCTPDisplay() {
            // For negotiate and revise, only show trust
            if (currentSeller.action === 'negotiate' || currentSeller.action === 'revise') {
                const status = `
                    <div style="text-align: center; font-size: 14px; font-weight: 600; color: var(--text-light);">
                        Trust Level: <span style="color: ${currentSeller.trust >= 3 ? '#48bb78' : '#f56565'};">${currentSeller.trust}</span>
                        <div style="font-size: 11px; color: var(--text-faded); margin-top: 5px;">Need Trust ≥3 to succeed</div>
                    </div>
                `;
                document.getElementById('mctpStatus').innerHTML = status;
                return;
            }

            // For 'show' action, display full MCTP
            const mctp = currentSeller.mctp;
            const mctpCount = Object.values(mctp).filter(v => v).length;
            const status = `
                <div style="font-size: 11px; color: var(--text-faded); margin-bottom: 8px;">
                    M=Motivation, C=Condition, T=Timeline, P=Price (Need 3/4 + Trust ≥3)
                </div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                    <div style="text-align: center;">
                        <div style="font-weight: 600; color: ${mctp.M ? '#48bb78' : '#f56565'};">M</div>
                        <div style="font-size: 11px;">${mctp.M ? 'Found' : 'Missing'}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-weight: 600; color: ${mctp.C ? '#48bb78' : '#f56565'};">C</div>
                        <div style="font-size: 11px;">${mctp.C ? 'Found' : 'Missing'}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-weight: 600; color: ${mctp.T ? '#48bb78' : '#f56565'};">T</div>
                        <div style="font-size: 11px;">${mctp.T ? 'Found' : 'Missing'}</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-weight: 600; color: ${mctp.P ? '#48bb78' : '#f56565'};">P</div>
                        <div style="font-size: 11px;">${mctp.P ? 'Found' : 'Missing'}</div>
                    </div>
                </div>
                <div style="margin-top: 8px; text-align: center; font-size: 12px; font-weight: 600; color: ${mctpCount >= 3 && currentSeller.trust >= 3 ? '#48bb78' : '#f56565'};">
                    Status: ${mctpCount}/4 MCTP | Trust: ${currentSeller.trust}
                </div>
            `;
            document.getElementById('mctpStatus').innerHTML = status;
        }

        function showNextDialogueChoice() {
            currentSeller.turn++;
            const scenarios = dialogueScenarios[currentSeller.action];

            // Determine available categories based on action type
            let availableCategories;
            if (currentSeller.action === 'negotiate') {
                availableCategories = ['pushback', 'objection'];
            } else if (currentSeller.action === 'revise') {
                availableCategories = ['adjustment'];
            } else {
                // 'show' action
                if (currentSeller.turn === 1) {
                    availableCategories = ['opening'];
                } else {
                    // Filter out already asked MCTP categories
                    availableCategories = ['motivation', 'condition', 'timeline', 'price']
                        .filter(cat => !currentSeller.askedCategories.includes(cat));

                    // If all categories have been asked, allow repeats
                    if (availableCategories.length === 0) {
                        availableCategories = ['motivation', 'condition', 'timeline', 'price'];
                    }
                }
            }

            const category = availableCategories[Math.floor(Math.random() * availableCategories.length)];

            // Track this category as asked (only for MCTP categories)
            if (currentSeller.action === 'show' && category !== 'opening') {
                currentSeller.askedCategories.push(category);
            }

            const choices = scenarios[category];

            // Safety check
            if (!choices || !Array.isArray(choices)) {
                console.error('No dialogue choices found for action:', currentSeller.action, 'category:', category);
                endSellerCall(true);
                return;
            }

            // Randomly pick 3 choices from the pool, then shuffle them
            const selectedChoices = choices
                .map((choice, idx) => ({ choice, originalIndex: idx }))
                .sort(() => Math.random() - 0.5)
                .slice(0, 3)
                .sort(() => Math.random() - 0.5);

            let choicesHTML = '<div style="margin-bottom: 10px; font-weight: 600; color: var(--text-light);">Choose your response:</div>';
            selectedChoices.forEach((item) => {
                choicesHTML += `<div class="property-option" onclick="selectDialogueChoice(${item.originalIndex}, '${category}')" style="cursor: pointer; margin-bottom: 10px;">
                    <div style="line-height: 1.6;">${item.choice.text}</div>
                </div>`;
            });

            document.getElementById('sellerChoices').innerHTML = choicesHTML;
        }

        function selectDialogueChoice(index, category) {
            if (!currentSeller) return; // Safety check

            // Disable all choices immediately to prevent double-clicking
            document.getElementById('sellerChoices').innerHTML = '<div style="color: #718096; padding: 10px;">Processing...</div>';

            const scenarios = dialogueScenarios[currentSeller.action];
            const choice = scenarios[category][index];

            // Apply impact
            currentSeller.trust += choice.impact.trust || 0;
            if (choice.impact.reveals) {
                currentSeller.mctp[choice.impact.reveals] = true;
            }

            // Add to dialogue history
            currentSeller.dialogue.push({ player: choice.text, trust: currentSeller.trust });

            // Generate contextual seller response
            let response = "";
            const trustChange = choice.impact.trust || 0;

            if (category === 'opening') {
                if (trustChange > 0) {
                    response = "Thank you for being professional. Yes, I am considering selling.";
                } else if (trustChange < 0) {
                    response = "Whoa, slow down there. I'm not sure I'm comfortable with this approach...";
                } else {
                    response = "Okay... what do you need to know?";
                }
            } else if (category === 'motivation') {
                if (choice.impact.reveals === 'M') {
                    const reasons = [
                        "We're relocating for work and need to move quickly.",
                        "I inherited this property and don't want to deal with it.",
                        "It's becoming too much to maintain at my age.",
                        "We're downsizing and this place is too big now."
                    ];
                    response = reasons[Math.floor(Math.random() * reasons.length)];
                } else {
                    response = "I don't think that's really relevant to our discussion.";
                }
            } else if (category === 'condition') {
                if (choice.impact.reveals === 'C') {
                    const conditions = [
                        "The roof needs some work, and the HVAC is original from the 80s.",
                        "It's in decent shape, mostly cosmetic updates needed.",
                        "There's some foundation cracking and plumbing issues.",
                        "Pretty good condition overall, just needs paint and flooring."
                    ];
                    response = conditions[Math.floor(Math.random() * conditions.length)];
                } else if (trustChange < 0) {
                    response = "I already told you there are some issues. Why are you being pushy?";
                } else {
                    response = "Sure, you can inspect it yourself.";
                }
            } else if (category === 'timeline') {
                if (choice.impact.reveals === 'T') {
                    const timelines = [
                        "Ideally within 30 days if possible.",
                        "As soon as we can - we're already moved out.",
                        "No huge rush, but within 60 days would be great.",
                        "We need to close before the end of next month."
                    ];
                    response = timelines[Math.floor(Math.random() * timelines.length)];
                } else if (trustChange < 0) {
                    response = "You seem more focused on your timeline than mine...";
                } else {
                    response = "Pretty soon, but it depends on the offer.";
                }
            } else if (category === 'price') {
                if (choice.impact.reveals === 'P') {
                    const priceMin = currentSeller.property.value * 1.2;
                    const priceMax = currentSeller.property.value * 1.4;
                    response = `I was hoping to get somewhere between $${Math.floor(priceMin/1000)}k and $${Math.floor(priceMax/1000)}k.`;
                } else if (trustChange < -1) {
                    response = "Look, if you're just trying to lowball me, we're done here.";
                } else {
                    response = "I'm flexible on price if everything else makes sense.";
                }
            } else if (category === 'pushback') {
                if (trustChange > 1) {
                    response = "Okay, I appreciate you working with me. Let's talk about it.";
                } else if (trustChange < 0) {
                    response = "That attitude isn't helping. Maybe I should talk to other buyers.";
                } else {
                    response = "Alright... but I still think my number is fair.";
                }
            } else if (category === 'objection') {
                if (trustChange > 1) {
                    response = "I appreciate you listening. Maybe we can adjust the terms or timeline?";
                } else if (trustChange < 0) {
                    response = "You're not hearing me. This isn't working.";
                } else {
                    response = "Okay, I'm listening...";
                }
            } else if (category === 'adjustment') {
                if (trustChange > 1) {
                    response = "Thank you for being flexible. Let me review this new offer.";
                } else if (trustChange < 0) {
                    response = "This still doesn't feel right to me.";
                } else {
                    response = "Alright, I'll consider it.";
                }
            } else {
                response = "I see... let me think about that.";
            }

            const dialogueDiv = document.getElementById('sellerDialogue');
            dialogueDiv.innerHTML += `
                <div style="margin-bottom: 15px;">
                    <div style="background: #2563eb20; padding: 10px; border-radius: 6px; margin-bottom: 8px;">
                        <strong>You:</strong> ${choice.text}
                    </div>
                    <div style="background: #25252520; padding: 10px; border-radius: 6px;">
                        <strong>Seller:</strong> ${response}
                    </div>
                </div>
            `;
            dialogueDiv.scrollTop = dialogueDiv.scrollHeight;

            updateMCTPDisplay();

            // Check if call failed (trust too low)
            if (currentSeller.trust <= 0) {
                setTimeout(() => endSellerCall(true), 1000);
                return;
            }

            // Continue or end based on turn count
            if (currentSeller.turn >= 5) {
                setTimeout(() => endSellerCall(false), 1000);
            } else {
                setTimeout(showNextDialogueChoice, 500);
            }
        }

        function endSellerCall(failed) {
            if (!currentSeller) return; // Safety check

            document.getElementById('sellerModal').classList.remove('active');

            if (failed) {
                g.deals = g.deals.filter(d => d.id !== currentSeller.property.id);
                notify(`Call failed! Seller lost trust.`);
                currentSeller = null;
                updateUI();
                renderDeals();
                renderActs();
                save();
                return;
            }

            // Calculate success based on action type
            let success;
            if (currentSeller.action === 'show') {
                // Show action requires MCTP + trust
                const mctpCount = Object.values(currentSeller.mctp).filter(v => v).length;
                success = mctpCount >= 3 && currentSeller.trust >= 3;
            } else {
                // Negotiate and revise only require trust
                success = currentSeller.trust >= 3;
            }

            if (success) {
                // Original success logic from execAct
                const p = currentSeller.property;
                if (currentSeller.action === 'show') {
                    const showRoll = Math.random();
                    if (showRoll < 0.30) {
                        p.stage = 'negotiation';
                        notify(`${p.address} interested!`, 'advance');
                    } else if (showRoll < 0.80) {
                        p.stage = 'followup';
                        notify(`${p.address} needs time.`);
                    } else {
                        g.deals = g.deals.filter(d => d.id !== p.id);
                        notify(`${p.address} fell through.`);
                    }
                } else if (currentSeller.action === 'negotiate') {
                    const negRoll = Math.random();
                    if (negRoll < 0.25) {
                        p.stage = 'contract';
                        notify(`${p.address} signed!`, 'advance');
                    } else if (negRoll < 0.85) {
                        p.stage = 'revision';
                        notify(`${p.address} needs better offer (will reduce profit).`);
                    } else {
                        g.deals = g.deals.filter(d => d.id !== p.id);
                        notify(`${p.address} fell through.`);
                    }
                } else if (currentSeller.action === 'revise') {
                    // 15-25% chance to fail
                    const reviseRoll = Math.random();
                    const failChance = 0.15 + Math.random() * 0.10; // Random between 15-25%

                    if (reviseRoll < failChance) {
                        g.deals = g.deals.filter(d => d.id !== p.id);
                        notify(`${p.address} rejected revised offer and fell through!`);
                    } else {
                        const reduction = Math.floor(p.value * (0.20 + Math.random() * 0.10));
                        const oldVal = p.value;
                        p.value = Math.max(1000, p.value - reduction);
                        p.stage = 'contract';
                        notify(`${p.address} accepted! (Profit reduced: $${oldVal} → $${p.value})`, 'advance');
                    }
                }
            } else {
                // Different failure messages based on action type
                if (currentSeller.action === 'show') {
                    const mctpCount = Object.values(currentSeller.mctp).filter(v => v).length;
                    notify(`Call incomplete. Need more MCTP info (${mctpCount}/4) and trust (${currentSeller.trust}/3).`);
                } else if (currentSeller.action === 'negotiate') {
                    notify(`Negotiation failed. Insufficient trust (${currentSeller.trust}/3 required).`);
                } else if (currentSeller.action === 'revise') {
                    notify(`Seller rejected revision. Trust too low (${currentSeller.trust}/3 required).`);
                }
            }

            currentSeller = null;
            updateUI();
            renderDeals();
            renderActs();
            save();
        }

        function showPropModal(a) {
            let deals = g.deals.filter(d => d.stage === a.stage);
            if (a.minVal) deals = deals.filter(d => d.value >= a.minVal);
            if (deals.length === 0) {
                notify(a.minVal ? `No properties over $${a.minVal.toLocaleString()}.` : `No ${a.stage} properties.`);
                return;
            }
            pend = a;
            const m = document.getElementById('propertyModal');
            const b = document.getElementById('propertyModalBody');
            document.getElementById('propertyModalTitle').textContent = `Select - ${a.name}`;
            b.innerHTML = `<div style="margin-bottom:15px;color:#718096;">Select property:</div><div class="property-list">
                ${deals.map(d => `<div class="property-option" data-id="${d.id}">
                <div style="font-weight:bold;margin-bottom:4px;">${d.address}</div>
                <div style="font-size:13px;color:#718096;">Fee: <span style="color:#48bb78;font-weight:bold;">$${d.value}</span></div></div>`).join('')}</div>`;
            document.querySelectorAll('.property-option').forEach(o => {
                o.addEventListener('click', function() {
                    document.querySelectorAll('.property-option').forEach(x => x.classList.remove('selected'));
                    this.classList.add('selected');
                    sel = deals.find(d => d.id === parseInt(this.dataset.id));
                });
            });
            m.classList.add('active');
        }

        function confirmProp() {
            if (!sel || !pend) return;

            // Store references before closing modal (closePropMod clears them)
            const action = pend;
            const property = sel;

            // Check if this is an interactive action
            if (action.interactive) {
                // 50% chance to trigger interactive dialogue
                if (Math.random() < 0.5) {
                    g.timeLeft -= action.time;
                    g.cash -= action.cost;
                    closePropMod();
                    startSellerInteraction(action, property);
                } else {
                    // Use original logic without dialogue
                    execAct(action, property);
                    closePropMod();
                }
            } else {
                execAct(action, property);
                closePropMod();
            }
        }

        // Make selectDialogueChoice available globally for onclick
        window.selectDialogueChoice = selectDialogueChoice;

        function closePropMod() {
            document.getElementById('propertyModal').classList.remove('active');
            sel = null;
            pend = null;
        }

        function execAct(a, p) {
            g.timeLeft -= a.time;
            g.cash -= a.cost;

            switch(a.id) {
                case 'analyze':
                    // 60% success, 40% fail
                    if (p && Math.random() < 0.60) {
                        p.stage = 'analyzed';
                        notify(`${p.address} analyzed!`, 'advance');
                    } else {
                        g.deals = g.deals.filter(d => d.id !== p.id);
                        notify('Numbers don\'t work.');
                    }
                    break;
                case 'show':
                    // 30% → negotiation, 50% → followup, 20% → dead
                    const showRoll = Math.random();
                    if (p && showRoll < 0.30) {
                        p.stage = 'negotiation';
                        notify(`${p.address} interested!`, 'advance');
                    } else if (showRoll < 0.80) {
                        p.stage = 'followup';
                        notify(`${p.address} needs time.`);
                    } else {
                        g.deals = g.deals.filter(d => d.id !== p.id);
                        notify(`${p.address} fell through.`);
                    }
                    break;
                case 'follow':
                    // 30% → negotiation, 50% → stay in followup, 20% → dead
                    const followRoll = Math.random();
                    if (p && followRoll < 0.30) {
                        p.stage = 'negotiation';
                        notify(`${p.address} ready!`, 'advance');
                    } else if (followRoll < 0.80) {
                        notify(`${p.address} still thinking.`);
                    } else {
                        g.deals = g.deals.filter(d => d.id !== p.id);
                        notify(`${p.address} fell through.`);
                    }
                    break;
                case 'revise':
                    // 15-25% chance to fail and fall through
                    if (p) {
                        const reviseRoll = Math.random();
                        const failChance = 0.15 + Math.random() * 0.10; // Random between 15-25%

                        if (reviseRoll < failChance) {
                            g.deals = g.deals.filter(d => d.id !== p.id);
                            notify(`${p.address} rejected revised offer and fell through!`);
                        } else {
                            const reduction = Math.floor(p.value * (0.20 + Math.random() * 0.10));
                            const oldVal = p.value;
                            p.value = Math.max(1000, p.value - reduction);
                            p.stage = 'contract';
                            notify(`${p.address} accepted! (Profit reduced: $${oldVal} → $${p.value})`, 'advance');
                        }
                    }
                    break;
                case 'negotiate':
                    // 25% → contract, 60% → revision, 15% → dead
                    const negRoll = Math.random();
                    if (p && negRoll < 0.25) {
                        p.stage = 'contract';
                        notify(`${p.address} signed!`, 'advance');
                    } else if (negRoll < 0.85) {
                        p.stage = 'revision';
                        notify(`${p.address} needs better offer (will reduce profit).`);
                    } else {
                        g.deals = g.deals.filter(d => d.id !== p.id);
                        notify(`${p.address} fell through.`);
                    }
                    break;
                case 'buyers':
                    // 30% → close, 50% → try again, 20% → dead
                    if (p) {
                        const roll = Math.random();
                        if (roll < 0.30) {
                            closeDeal(p);
                        } else if (roll < 0.80) {
                            notify('Contacted buyers, no interest yet.');
                        } else {
                            g.deals = g.deals.filter(d => d.id !== p.id);
                            notify(`${p.address} contract fell through! Buyer backed out.`);
                        }
                    }
                    break;
                case 'maxdispo':
                    if (p) {
                        const halfVal = Math.floor(p.value * 0.5);
                        const dis = g.team.find(m => m.role === 'Dis');
                        let tot = halfVal;
                        if (dis) tot += dis.bonus;
                        g.cash += tot;
                        g.totalProfit += tot;
                        g.dealsClosedTotal++;

                        // Track closed deal
                        g.closedDeals.push({
                            address: p.address,
                            profit: tot,
                            week: g.week,
                            baseValue: p.value,
                            method: 'MaxDispo'
                        });

                        g.deals = g.deals.filter(x => x.id !== p.id);
                        notify(`${p.address} closed via Max! $${tot} (50% fee)`, 'advance');
                        renderHire();
                        renderUpg();
                    }
                    break;
                case 'admin':
                    g.adminBlocked = false;
                    notify('Admin tasks completed! Actions unlocked.', 'advance');
                    break;
            }

            // Random chance (15%) to require admin work after property actions
            if (a.prop && Math.random() < 0.15 && !g.adminBlocked) {
                g.adminBlocked = true;
                notify('Admin work piling up! Must complete admin tasks before continuing.', 'neutral');
            }

            updateUI();
            renderDeals();
            renderActs();
            save();
        }

        function genLeads(cnt, stage) {
            stage = stage || 'lead';
            for (let i = 0; i < cnt; i++) {
                g.deals.push({
                    id: Date.now() + i,
                    address: Math.floor(Math.random() * 9999) + 100 + ' Main St',
                    value: Math.floor(Math.random() * 12000) + 5000,
                    stage: stage,
                    week: g.week
                });
            }
        }

        function closeDeal(d) {
            let tot = d.value;
            if (g.upgrades.maxd) tot += Math.floor(d.value * 0.5);
            const dis = g.team.find(m => m.role === 'Dis');
            if (dis) tot += dis.bonus;
            g.cash += tot;
            g.totalProfit += tot;
            g.dealsClosedTotal++;

            // Track closed deal
            g.closedDeals.push({
                address: d.address,
                profit: tot,
                week: g.week,
                baseValue: d.value
            });

            g.deals = g.deals.filter(x => x.id !== d.id);
            notify(`${d.address} closed! $${tot}`, 'advance');
            updateUI();
            renderDeals();
            renderHire();
            renderUpg();
            save();
        }

        function renderDeals() {
            const p = document.getElementById('dealPipeline');
            const stages = { lead: 'New Leads', qualified: 'Qualified', analyzed: 'Analyzed', followup: 'Follow Up', revision: 'Revision', negotiation: 'Negotiation', contract: 'Contract' };
            p.innerHTML = Object.entries(stages).map(([s, t]) => {
                const ds = g.deals.filter(d => d.stage === s);
                return `<div class="pipeline-column"><div class="pipeline-title">${t} (${ds.length})</div>
                    ${ds.map(d => `<div class="deal-card"><div>${d.address}</div><div class="deal-value">$${d.value}</div></div>`).join('')}</div>`;
            }).join('');
        }

        function renderStats() {
            const container = document.getElementById('statsContent');

            // Title system based on total profit
            const titles = [
                { threshold: 0, title: '<i class="fa-solid fa-seedling"></i> Rookie Wholesaler', color: '#718096' },
                { threshold: 10000, title: '<i class="fa-solid fa-briefcase"></i> Junior Deal Maker', color: '#4299e1' },
                { threshold: 25000, title: '<i class="fa-solid fa-bullseye"></i> Skilled Wholesaler', color: '#48bb78' },
                { threshold: 50000, title: '<i class="fa-solid fa-star"></i> Expert Flipper', color: '#ed8936' },
                { threshold: 100000, title: '<i class="fa-solid fa-gem"></i> Master Wholesaler', color: '#9f7aea' },
                { threshold: 250000, title: '<i class="fa-solid fa-crown"></i> Elite Investor', color: '#f56565' },
                { threshold: 500000, title: '<i class="fa-solid fa-trophy"></i> Tycoon Legend', color: '#d69e2e' },
                { threshold: 1000000, title: '<i class="fa-solid fa-fire"></i> Million Dollar Mogul', color: '#e53e3e' }
            ];

            let currentTitle = titles[0];
            for (let i = titles.length - 1; i >= 0; i--) {
                if (g.totalProfit >= titles[i].threshold) {
                    currentTitle = titles[i];
                    break;
                }
            }

            const nextTitle = titles.find(t => t.threshold > g.totalProfit);
            const avgProfit = g.closedDeals.length > 0 ? Math.floor(g.totalProfit / g.closedDeals.length) : 0;

            let html = `
                <div class="card" style="text-align: center; background: linear-gradient(135deg, ${currentTitle.color}20 0%, ${currentTitle.color}10 100%); border: 3px solid ${currentTitle.color};">
                    <div style="font-size: 28px; font-weight: bold; color: ${currentTitle.color}; margin-bottom: 10px;">
                        ${currentTitle.title}
                    </div>
                    <div style="font-size: 16px; color: #718096; margin-bottom: 20px;">
                        Total Profit: <span style="color: #48bb78; font-weight: bold;">$${g.totalProfit.toLocaleString()}</span>
                    </div>
                    ${nextTitle ? `<div style="font-size: 14px; color: #718096;">
                        Next: ${nextTitle.title} at $${nextTitle.threshold.toLocaleString()}
                        <div style="margin-top: 10px;"><div class="progress-bar" style="height: 12px;">
                            <div class="progress-fill" style="width: ${Math.min(100, (g.totalProfit / nextTitle.threshold) * 100)}%"></div>
                        </div></div>
                    </div>` : '<div style="font-size: 14px; color: #48bb78; font-weight: bold;"><i class="fa-solid fa-trophy"></i> MAX RANK ACHIEVED! <i class="fa-solid fa-trophy"></i></div>'}
                </div>

                <div class="card" style="margin-top: 20px;">
                    <div class="card-title"><i class="fa-solid fa-chart-bar"></i> Career Statistics</div>
                    <div class="info-row"><span class="info-label">Total Deals Closed:</span><span class="info-value">${g.dealsClosedTotal}</span></div>
                    <div class="info-row"><span class="info-label">Total Profit Earned:</span><span class="info-value" style="color: #48bb78;">$${g.totalProfit.toLocaleString()}</span></div>
                    <div class="info-row"><span class="info-label">Average Profit/Deal:</span><span class="info-value">$${avgProfit.toLocaleString()}</span></div>
                    <div class="info-row"><span class="info-label">Current Week:</span><span class="info-value">${g.week}</span></div>
                    <div class="info-row"><span class="info-label">Current Cash:</span><span class="info-value" style="color: ${g.cash >= 0 ? '#48bb78' : '#f56565'};">$${g.cash.toLocaleString()}</span></div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <div class="card-title"><i class="fa-solid fa-scroll"></i> Deal History (Recent ${Math.min(10, g.closedDeals.length)})</div>
                    ${g.closedDeals.length === 0 ?
                        '<div style="text-align: center; padding: 40px; color: #718096;"><div style="font-size: 48px; margin-bottom: 15px;"><i class="fa-solid fa-folder-open"></i></div><div>No closed deals yet. Get out there and close some deals!</div></div>' :
                        '<div style="max-height: 400px; overflow-y: auto;">' +
                        g.closedDeals.slice().reverse().slice(0, 10).map(d => `
                            <div class="info-row" style="padding: 12px 0;">
                                <div>
                                    <div style="font-weight: bold;">${d.address}</div>
                                    <div style="font-size: 12px; color: #718096;">Week ${d.week}${d.method ? ' • ' + d.method : ''}</div>
                                </div>
                                <div style="font-weight: bold; color: #48bb78; font-size: 16px;">$${d.profit.toLocaleString()}</div>
                            </div>
                        `).join('') + '</div>'
                    }
                </div>
            `;

            container.innerHTML = html;
        }

        function renderTeam() {
            const grid = document.getElementById('teamGrid');
            const msg = document.getElementById('soloMessage');
            if (g.team.length === 0) {
                grid.style.display = 'none';
                msg.style.display = 'block';
                return;
            }
            grid.style.display = 'grid';
            msg.style.display = 'none';
            grid.innerHTML = g.team.map(m => `<div class="team-member">
                <div class="team-member-header"><div><div class="team-member-name">${m.name}</div>
                <div class="team-member-role">${m.role}</div></div>
                <button class="button button-small button-danger" onclick="fire('${m.id}')">Fire</button></div>
                <div class="info-row"><span class="info-label">Monthly:</span><span class="info-value">$${m.cost}</span></div>
                <div style="margin-top:10px;"><div style="font-size:12px;color:#718096;margin-bottom:5px;">Eff: ${m.eff}%</div>
                <div class="progress-bar"><div class="progress-fill" style="width:${m.eff}%"></div></div></div></div>`).join('');
        }

        function renderHire() {
            const grid = document.getElementById('hireGrid');
            grid.innerHTML = Object.entries(teams).map(([k, t]) => {
                const cost = t.reqC || (t.cost * 3);
                const ok = g.cash >= cost && (!t.reqD || g.dealsClosedTotal >= t.reqD);
                return `<div class="hire-card"><div class="card-title">${t.name}</div>
                    <div style="color:#718096;margin-bottom:15px;font-size:14px;">${t.desc}</div>
                    <div class="info-row"><span class="info-label">Monthly:</span><span class="info-value">$${t.cost}</span></div>
                    <div class="info-row"><span class="info-label">Hire (3mo):</span><span class="info-value">$${cost}</span></div>
                    ${t.reqD ? `<div class="info-row"><span class="info-label">Requires:</span><span class="info-value">${t.reqD} deals</span></div>` : ''}
                    <div style="margin-top:15px;"><button class="button ${ok ? 'button-success' : ''}" onclick="hire('${k}')" ${!ok ? 'disabled' : ''}>
                    ${ok ? 'Hire' : 'Locked'}</button></div></div>`;
            }).join('');
        }

        function renderUpg() {
            const grid = document.getElementById('upgradeGrid');
            grid.innerHTML = Object.entries(upg).map(([k, u]) => {
                const own = g.upgrades[k] || false;
                const ok = g.cash >= u.cost && (!u.reqD || g.dealsClosedTotal >= u.reqD) && !own;
                return `<div class="hire-card"><div class="card-title">${u.name} ${own ? '✓' : ''}</div>
                    <div style="color:#718096;margin-bottom:15px;font-size:14px;">${u.ben}</div>
                    <div class="info-row"><span class="info-label">Cost:</span><span class="info-value">${u.cost === 0 ? 'FREE' : '$' + u.cost.toLocaleString()}</span></div>
                    ${u.monthly ? `<div class="info-row"><span class="info-label">Monthly:</span><span class="info-value">$${u.monthly}/mo</span></div>` : ''}
                    ${u.reqD ? `<div class="info-row"><span class="info-label">Requires:</span><span class="info-value">${u.reqD} deals</span></div>` : ''}
                    <div style="margin-top:15px;"><button class="button ${ok ? 'button-success' : ''}" onclick="buyUpg('${k}')" ${!ok ? 'disabled' : ''}>
                    ${own ? 'Owned' : (ok ? 'Buy' : 'Locked')}</button></div></div>`;
            }).join('');
        }

        function buyUpg(k) {
            const u = upg[k];
            if (g.upgrades[k] || g.cash < u.cost) return;
            g.cash -= u.cost;
            g.upgrades[k] = true;
            if (k === 'enzo') g.timeLeft += 30;
            notify(`${u.name} bought!`, 'advance');
            updateUI();
            renderUpg();
            renderActs();
            save();
        }

        function hire(k) {
            const t = teams[k];
            const cost = t.reqC || (t.cost * 3);
            if (g.cash < cost) { notify('Not enough cash!'); return; }
            g.cash -= cost;
            g.team.push({ id: Date.now().toString(), name: t.name, role: t.role, cost: t.cost, time: t.time, desc: t.desc, eff: t.eff, mor: t.mor, leads: t.leads, deals: t.deals, bonus: t.bonus, week: g.week });
            notify(`${t.name} hired!`, 'advance');
            updateUI();
            renderTeam();
            renderHire();
            save();
        }

        function fire(id) {
            if (!confirm('Fire this team member?')) return;
            g.team = g.team.filter(m => m.id !== id);
            notify('Fired.');
            updateUI();
            renderTeam();
            save();
        }

        function advWeek() {
            if (g.week % 4 === 0) {
                let costs = g.team.reduce((sum, m) => sum + m.cost, 0);
                // Add monthly costs from upgrades
                Object.entries(upg).forEach(([k, u]) => {
                    if (g.upgrades[k] && u.monthly) {
                        costs += u.monthly;
                    }
                });
                if (g.cash < costs) {
                    showBankruptcy(costs);
                    return;
                }
                g.cash -= costs;
                notify('Monthly paid: $' + costs);
            }

            g.team.forEach(m => { if (m.eff < 100) m.eff = Math.min(100, m.eff + 10); });
            g.team.forEach(m => {
                if (m.role === 'VA' && m.leads) {
                    const l = Math.floor(m.leads * (m.eff / 100));
                    if (l > 0) {
                        genLeads(l);
                        notify(`${m.name}: ${l} leads!`, 'advance');
                    }
                }
            });

            g.week++;
            g.timeLeft = 40;
            g.team.forEach(m => { g.timeLeft += Math.floor(m.time * (m.eff / 100)); });
            if (g.upgrades.enzo) g.timeLeft += 30;

            // Clear admin block at start of new week
            if (g.adminBlocked) {
                g.adminBlocked = false;
                notify('Admin slate cleared for new week!', 'advance');
            }

            updateUI();
            renderDeals();
            renderActs();
            save();
            notify(`Week ${g.week}: ${g.timeLeft}h available.`, 'advance');
        }

        function updateUI() {
            document.getElementById('cash').textContent = g.cash.toLocaleString();
            document.getElementById('week').textContent = g.week;
            document.getElementById('dealsCount').textContent = g.dealsClosedTotal;
            document.getElementById('timeLeft').textContent = g.timeLeft.toFixed(2);

            // Auto-advance to next week if time runs out
            if (g.timeLeft <= 0 && !autoAdvancing) {
                autoAdvancing = true;
                setTimeout(() => {
                    notify('Week ended - out of time! Auto-advancing...', 'advance');
                    setTimeout(() => {
                        advWeek();
                        autoAdvancing = false;
                    }, 1000);
                }, 500);
            }
        }

        function notify(msg, type) {
            notifQueue.push({ msg, type: type || 'neutral' });
            if (!notifActive) showNextNotif();
        }

        function showNextNotif() {
            if (notifQueue.length === 0) {
                notifActive = false;
                return;
            }
            notifActive = true;
            const { msg, type } = notifQueue.shift();
            const n = document.createElement('div');
            n.className = 'notification';
            if (type === 'advance') {
                n.style.borderLeftColor = '#48bb78';
                n.style.background = '#f0fdf4';
            } else {
                n.style.borderLeftColor = '#f56565';
                n.style.background = '#fef2f2';
            }
            n.textContent = msg;
            document.body.appendChild(n);
            setTimeout(() => {
                n.remove();
                showNextNotif();
            }, 800);
        }

        function showBankruptcy(expenses) {
            const avgProfit = g.closedDeals.length > 0 ? Math.floor(g.totalProfit / g.closedDeals.length) : 0;

            document.getElementById('modalTitle').innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> BANKRUPT!';
            document.getElementById('modalBody').innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 20px; color: #f56565;">
                        <i class="fa-solid fa-money-bill-crack"></i>
                    </div>
                    <div style="font-size: 20px; font-weight: bold; margin-bottom: 15px; color: #f56565;">
                        Your wholesaling journey ends here.
                    </div>
                    <div style="font-size: 14px; color: var(--text-faded); margin-bottom: 25px;">
                        Unable to pay monthly expenses of $${expenses.toLocaleString()}
                    </div>

                    <div style="background: #252525; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 15px; color: var(--text-light);">
                            Final Stats
                        </div>
                        <div class="info-row">
                            <span class="info-label">Weeks Survived:</span>
                            <span class="info-value">${g.week}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Deals Closed:</span>
                            <span class="info-value">${g.dealsClosedTotal}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Total Profit Earned:</span>
                            <span class="info-value" style="color: #48bb78;">$${g.totalProfit.toLocaleString()}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Average Profit/Deal:</span>
                            <span class="info-value">$${avgProfit.toLocaleString()}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Team Members:</span>
                            <span class="info-value">${g.team.length}</span>
                        </div>
                    </div>

                    <button class="button button-success" onclick="startNewGame()" style="width: 100%; font-size: 16px; padding: 15px;">
                        <i class="fa-solid fa-rotate-right"></i> New Game
                    </button>
                </div>
            `;
            document.getElementById('modal').classList.add('active');
        }

        function showMod(title, body) {
            document.getElementById('modalTitle').innerHTML = title;
            document.getElementById('modalBody').innerHTML = body;
            document.getElementById('modal').classList.add('active');
        }

        function closeMod() {
            document.getElementById('modal').classList.remove('active');
        }

        function save() {
            g.lastPlayTime = Date.now();
            localStorage.setItem('teamBuildingTycoon', JSON.stringify(g));
        }

        function load() {
            const s = localStorage.getItem('teamBuildingTycoon');
            if (s) Object.assign(g, JSON.parse(s));
        }

        function reset() {
            if (!confirm('Reset?')) return;
            localStorage.removeItem('teamBuildingTycoon');
            location.reload();
        }

        function startNewGame() {
            localStorage.removeItem('teamBuildingTycoon');
            location.reload();
        }

        init();
    </script>
</body>
</html>
